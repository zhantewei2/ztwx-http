var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{tk:()=>h,Di:()=>E,Pp:()=>n,LI:()=>b,eV:()=>o,oJ:()=>g,DY:()=>C,wn:()=>v,cf:()=>r,HM:()=>s,PJ:()=>O,f0:()=>w,n:()=>_,m2:()=>A,OJ:()=>H,$L:()=>u,Tn:()=>x,u:()=>P});class r{method;url;body;responseType;timeout;headers;withCredentials;xhr;voyoInfo;mergeInfo}class s{status;method;headers;result;xhr}class o{req;res;hooks={};errorType;errorEvent;constructor(){this.req=new r,this.res=new s}}class n extends Error{}const a=(e,t)=>{try{e.length&&e[0]((t=>a(e.slice(1),t)),t)}catch(e){console.error(e)}},i=(e,t)=>{e.length?e[0]((()=>i(e.slice(1),t))):t()},l=(p={Observable:()=>__WEBPACK_EXTERNAL_MODULE_null__.Observable,from:()=>__WEBPACK_EXTERNAL_MODULE_null__.from,of:()=>__WEBPACK_EXTERNAL_MODULE_null__.of},d={},e.d(d,p),d);var p,d;class h{xhr;start(e){return new l.Observable((t=>{const r=new XMLHttpRequest,{req:s,res:o,hooks:n}=e;a([t=>{const o={target:e,xhr:r,req:s};n.preHandler&&n.preHandler.call(e,o),n.preHandlerAsync?n.preHandlerAsync.call(e,o).then(t):t()},t=>{s.timeout&&(r.timeout=s.timeout),s.withCredentials&&(r.withCredentials=s.withCredentials),n.progressHandler&&(r.onprogress=t=>n.progressHandler.call(e,{progressEvent:t,target:e})),t()},e=>{r.onreadystatechange=t=>{4===r.readyState&&0!==r.status&&(o.status=r.status,o.result=r.response,o.headers=(e=>{if(!e)return{};const t={};let r,s;return e.trim().split(/[\r\n]+/).forEach((o=>{e&&([r,s]=o.split(": "),t[r]=s)})),t})(r.getAllResponseHeaders()),e({}))},r.addEventListener("abort",(t=>e({errorType:"abort",errorEvent:t}))),r.addEventListener("error",(t=>e({errorType:"error",errorEvent:t}))),r.addEventListener("timeout",(t=>e({errorType:"timeout",errorEvent:t}))),((e,t)=>{const s=e.unsubscribe;e.unsubscribe=()=>{r.abort(),s.call(e)}})(t),r.open(s.method,s.url),s.responseType&&(r.responseType=s.responseType),s.headers&&((e,t)=>{t&&Object.keys(t).forEach((r=>e.setRequestHeader(r,t[r])))})(r,s.headers),r.send(s.body)},(t,r)=>{const a={target:e,res:o,req:s,...r};e.errorEvent=r.errorEvent,e.errorType=r.errorType,n.afterCompletion&&n.afterCompletion.call(e,a),n.afterCompletionAsync?n.afterCompletionAsync.call(e,a).then(t):t()},r=>{e.errorType?(n.errorTrigger&&n.errorTrigger({errorType:e.errorType,errorEvent:e.errorEvent,target:e}),t.error({http:e})):t.next({http:e}),t.complete()}])}))}}class u{start(e){return new l.Observable((t=>{const{req:r,res:s,hooks:o}=e,n={};a([t=>{const s={target:e,req:r};o.preHandler&&o.preHandler.call(e,s),o.preHandlerAsync?o.preHandlerAsync.call(e,s).then(t):t()},e=>{r.timeout&&(n.timeout=r.timeout),r.responseType&&("json"===r.responseType?(n.responseType="text",n.dataType="json"):"text"===r.responseType?(n.responseType="text",n.dataType=void 0):(n.responseType="arraybuffer",n.dataType=void 0)),e()},e=>{wx.request({...n,method:r.method,url:r.url,header:r.headers||{},data:r.body,success(t){s.status=t.statusCode,s.result=t.data,s.headers=t.header,e({})},fail(t){const r=t.errMsg.indexOf("timeout")>=0?"timeout":t.errMsg.indexOf("abort")>=0?"abort":"error";e({errorType:r,errorEvent:t})}})},(t,n)=>{const a={target:e,res:s,req:r,...n};e.errorEvent=n.errorEvent,e.errorType=n.errorType,o.afterCompletion&&o.afterCompletion.call(e,a),o.afterCompletionAsync?o.afterCompletionAsync.call(e,a).then(t):t()},r=>{e.errorType?(o.errorTrigger&&o.errorTrigger({errorType:e.errorType,errorEvent:e.errorEvent,target:e}),t.error({http:e})):t.next({http:e}),t.complete()}])}))}}class c{list;tap(e){this.list=this.list||[],this.list.push(e)}run(e){this.list&&this.list.forEach((t=>t(e)))}}class y{list;tap(e){this.list=this.list||[],this.list.push(e)}runInline(e){if(!this.list)return e;for(const t of this.list)e=t(e);return e}}class m{list;tapAsync(e){this.list=this.list||[],this.list.push(e)}run(e,t){return this.list?new Promise(((r,s)=>i(this.list.map((o=>n=>o(e).then((e=>e&&t?r(e):n())).catch(s))),(()=>r(void 0))))):Promise.resolve(void 0)}}const f=(t=>{var r={};return e.d(r,t),r})({map:()=>__WEBPACK_EXTERNAL_MODULE_null__.map,mergeMap:()=>__WEBPACK_EXTERNAL_MODULE_null__.mergeMap});class g{preHandler=new c;preHandlerAsync=new m;progressHandler=new c;afterCompletion=new c;afterCompletionAsync=new m;errorTrigger=new c}class H{httpPluginHandlers=new g;pluginList=[];beforeHandlerAsync=new m;afterHandlerAsync=new m;wrapperHandler=new y;addPlugin(e){this.pluginList.find((t=>t.name===e.name))||this.pluginList.push(e)}removePlugin(e){const t=this.pluginList.findIndex((t=>t.name===e));void 0!==t&&this.pluginList.splice(t,1)}initPlugin(){this.pluginList.sort(((e,t)=>t.priority-e.priority)),this.pluginList.forEach((e=>{e.before&&this.beforeHandlerAsync.tapAsync((t=>e.before(t))),e.after&&this.afterHandlerAsync.tapAsync((t=>e.after(t.after,t.before))),e.registryHooks&&e.registryHooks({httpPluginHandlers:this.httpPluginHandlers}),e.wrapper&&this.wrapperHandler.tap((t=>({http:t.http,httpObserver:e.wrapper(t)}))),e.patchCall&&e.patchCall(this)}))}wrapperHttp(e,t,r){e.hooks.preHandler=e=>this.httpPluginHandlers.preHandler.run(e),e.hooks.preHandlerAsync=e=>this.httpPluginHandlers.preHandlerAsync.run(e),e.hooks.progressHandler=e=>this.httpPluginHandlers.progressHandler.run(e),e.hooks.afterCompletion=e=>this.httpPluginHandlers.afterCompletion.run(e),e.hooks.afterCompletionAsync=e=>this.httpPluginHandlers.afterCompletionAsync.run(e),e.hooks.errorTrigger=e=>this.httpPluginHandlers.errorTrigger.run(e),Object.freeze(e.hooks);const s={http:e,httpParams:t};return(0,l.from)(this.beforeHandlerAsync.run(s,!0)).pipe((0,f.mergeMap)((t=>{const o=(t||r()).pipe((0,f.mergeMap)((e=>(0,l.from)(this.afterHandlerAsync.run({after:e,before:s}).then((()=>e))))));return this.wrapperHandler.runInline({http:e,httpObserver:o}).httpObserver})))}}class b extends H{transmitter;setTransmitter(e){this.transmitter=e}xhr(e){if(!this.transmitter)throw new n("Must specify an transmitter.");const t=new o;return t.req.url=e.url||"",t.req.method=e.method,this.wrapperHttp(t,e,(()=>this.transmitter.start(t)))}}const T=(t=>{var r={};return e.d(r,t),r})({additionUrl:()=>__WEBPACK_EXTERNAL_MODULE_null__.additionUrl,queryparams:()=>__WEBPACK_EXTERNAL_MODULE_null__.queryparams}),E=0;class v{data={};constructor(e,t){const r={};for(const t in e)r[t]={value:e[t],priority:E};this.data=t?Object.assign(r,t):r}addType(e){this.add({key:"Content-Type",value:e},!1)}add(e,t=!0){!t&&this.data[e.key]||(this.data[e.key]={value:e.value,priority:e.priority||E})}combineToRecord(e,t){const r={};return new Set(Object.keys(e).concat(Object.keys(t))).forEach((s=>{r[s]=e[s]?t[s]?e[s].priority>=t[s].priority?e[s].value:t[s].value:e[s].value:t[s].value})),r}}class w{name="voyo-base-plugin";priority=100;hostAddress;globalPriorityHeaders=new v({});withCredentials=!0;defaultContentType="application/json";defaultResponseType="json";patchCall(e){e.setHost=e=>{this.hostAddress=e},e.setGlobalHeader=(e,t,r)=>{this.globalPriorityHeaders.add({key:e,value:t,priority:r})},e.setWithCredentials=e=>this.withCredentials=e}defineResponseType(e,t){t.responseType=e.responseType||this.defaultResponseType}defineRequestUrl(e,t){t.url=t.url||((e="",t="")=>("/"===e[e.length-1]?e.slice(0,e.length-1):e)+("/"===t[0]?t:"/"+t))(this.hostAddress,e.path)}before({http:e,httpParams:t}){const{req:r}=e,{headers:s={},priorityHeaders:o={}}=t;r.headers=r.headers||{},this.defineRequestUrl(t,r),this.defineResponseType(t,r),r.withCredentials=t.withCredentials??this.withCredentials;const n=new v(Object.assign(s,r.headers),o),a=r.voyoInfo=r.voyoInfo||{};var i;return t.query&&(e.req.url+="?"+T.queryparams.encode(t.query,(!0,null==(i=t.queryURIEncode)||i))),t.json?(!t.noAutoHeader&&n.addType("application/json"),r.body=JSON.stringify(t.json),a.contentType="json"):t.arrayBuffer||t.blob?(!t.noAutoHeader&&n.addType("application/octet-stream"),r.body=t.arrayBuffer||t.blob,a.contentType="stream"):t.formData?(!t.noAutoHeader&&n.addType("application/x-www-form-urlencoded"),r.body=t.formData,a.contentType="formData"):(!t.noAutoHeader&&n.addType(this.defaultContentType),r.body=t.body),r.headers=Object.assign(r.headers,n.combineToRecord(n.data,this.globalPriorityHeaders.data)),Promise.resolve()}registryHooks({httpPluginHandlers:e}){e.afterCompletion.tap((({res:e,req:t})=>{if("json"===t.responseType&&e.result&&"string"==typeof e.result)try{e.result=JSON.parse(e.result)}catch(e){console.debug("Failed to parse JSON format.",e)}}))}wrapper({httpObserver:e}){return e.pipe((0,f.map)((e=>{const t=e.http.res;return e.statusCode=t.status,e.result=t.result,e})))}}class C{store=new Map;total=0;maxCount;controllerCount;constructor(e=100,t=10){this.maxCount=e,this.controllerCount=t}add(e,t){this.store.has(e)||(this.store.set(e,t),this.total++,this.addCheck())}has(e){return this.store.has(e)}get(e){return this.store.get(e)}addCheck(){if(this.total>this.maxCount){let e=0;const t=this.store.keys();for(const r of t)if(this.store.delete(r),++e>this.controllerCount)break;this.total-=this.controllerCount}}del(e){this.store.has(e)&&(this.store.delete(e),this.total--)}}class _{name="voyo-cache-plugin";priority=99;defaultExpireSeconds;limitStore;getNowDate(){return Math.round(Date.now()/1e3)}constructor({maxCount:e,controllerCount:t,defaultExpireSeconds:r}){this.defaultExpireSeconds=r||0,this.limitStore=new C(e,t)}isExpire(e,t){return 0!==t&&t<this.getNowDate()&&(this.limitStore.del(e),!0)}before({http:e,httpParams:{cacheOpts:t}}){if(t&&t.key){const r=this.limitStore.get(t.key);if(r&&!this.isExpire(t.key,r.expireDate))return Object.assign(e.res,r.http.res),Object.assign(e.req,r.http.req),Promise.resolve((0,l.of)({http:e}))}return Promise.resolve()}after(e,{httpParams:{cacheOpts:t},http:r}){return t?(this.limitStore.add(t.key,{expireDate:null==t.expireSeconds?this.defaultExpireSeconds:this.getNowDate()+t.expireSeconds,http:{req:r.req,res:r.res}}),Promise.resolve()):Promise.resolve()}}class A extends b{constructor({transmitter:e=new h}){super(),this.setTransmitter(e),this.addPlugin(new w)}}const P=(e,t)=>t&&Object.entries(t).forEach((([t,r])=>e.setRequestHeader(t,r)));class O{globalHeaders={};addGlobalHeader(e,t){this.globalHeaders[e]=t}constructor(){}send({method:e,url:t,query:r,json:s,body:o,headers:n={}}){return new Promise(((a,i)=>{const l=new XMLHttpRequest;l.responseType="json",n=Object.assign({"content-type":"application/json",...n},this.globalHeaders),r&&(0,T.additionUrl)(t,r),s&&(o=JSON.stringify(s)),l.onreadystatechange=()=>{4===l.readyState&&0!==l.status&&(200==l.status?a({status:l.status,content:l.response}):i({status:l.status,content:l.response}))},l.open(e,t),P(l,n),l.withCredentials=!0,l.send(o)}))}}const x=new O;var q=t.tk,L=t.Di,k=t.Pp,j=t.LI,R=t.eV,D=t.oJ,M=t.DY,S=t.wn,N=t.cf,U=t.HM,I=t.PJ,B=t.f0,J=t.n,W=t.m2,X=t.OJ,K=t.$L,V=t.Tn,Y=t.u;export{q as Ajax,L as DEFAULT_PRIORITY,k as Exception,j as HighHttp,R as Http,D as HttpPluginHandlers,M as LimitStore,S as PriorityHeaders,N as Request,U as Response,I as SampleHttp,B as VoyoBasePlugin,J as VoyoCachePlugin,W as VoyoHttp,X as VoyoHttpPluginManager,K as Weixin,V as sampleHttp,Y as xhrAssemblyHeader};